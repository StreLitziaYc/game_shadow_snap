name: Build and Release EXE

on:
  # 1. 当推送 v 开头的 tag 时触发（用于正式发布）
  push:
    tags:
      - "v*"

  # 2. 【新增】当对 main 分支发起 PR 时触发（用于代码检查）
  pull_request:
    branches:
      - master

  # 3. 手动触发
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build GameShadowSnap
    runs-on: windows-latest  # 必须用 Windows 环境构建，否则生成的 EXE 无法在 Windows 跑

    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Python 环境 (使用 3.10 版本，稳定且兼容性好)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # 4. 版本号注入 (Version Injection)
      # 仅在打 Tag 时触发 (例如 v1.2.0)
      - name: Inject Version into Code
        if: startsWith(github.ref, 'refs/tags/')
        shell: powershell
        run: |
          $tag = "${{ github.ref_name }}"
          echo "正在注入版本号: $tag"
          
          $path = "src/config.py"
          $content = Get-Content $path
          
          # 正则替换：找到 APP_VERSION = ... 那一行，替换为当前 Tag
          # 这里的逻辑是寻找 'APP_VERSION = ' 开头的内容进行整行替换，确保精准
          $newContent = $content -replace 'APP_VERSION = .*', "APP_VERSION = `"$tag`""
          
          $newContent | Set-Content $path
          
          # 打印一下文件内容确认替换成功 (用于调试 Action 日志)
          Get-Content $path | Select-String "APP_VERSION"

      # 5. 打包生成 EXE
      - name: Build with PyInstaller
        run: |
          pyinstaller -F -w --uac-admin --icon=camera.ico --add-data "camera.ico;." --add-data "src;src" --collect-all certifi --collect-all requests -n "GameShadowSnap" main.py

      # 6. 生成默认 config.json 并打包成 Zip
      - name: Create Config and Zip Package
        shell: powershell
        run: |
          # A. 定义 JSON 内容并写入文件 (使用 UTF8 编码)
          $configContent = '{
              "hotkey": "f12",
              "save_dir": "./screenshots",
              "show_notification": true,
              "suppress_key": true,
              "auto_update": true,
              "proxy_port": ""
          }'
          $configContent | Out-File -FilePath config.json -Encoding utf8

          # B. 创建一个临时文件夹用来放要打包的东西
          New-Item -ItemType Directory -Force -Path release_package

          # C. 把 EXE 和 Config 复制进去
          Copy-Item dist\GameShadowSnap.exe -Destination release_package\
          Copy-Item config.json -Destination release_package\

          # D. 压缩成 Zip
          Compress-Archive -Path release_package\* -DestinationPath GameShadowSnap.zip

      # 7. 发布 Release (上传的是 Zip 文件)
      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # 注意：这里改成了上传 zip
          files: GameShadowSnap.zip
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false