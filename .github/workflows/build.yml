name: Build and Release EXE

on:
  # 1. 当推送 v 开头的 tag 时触发（用于正式发布）
  push:
    tags:
      - "v*"

  # 2. 【新增】当对 main 分支发起 PR 时触发（用于代码检查）
  pull_request:
    branches:
      - master

  # 3. 手动触发
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build GameShadowSnap
    runs-on: windows-latest  # 必须用 Windows 环境构建，否则生成的 EXE 无法在 Windows 跑

    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Python 环境 (使用 3.10 版本，稳定且兼容性好)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. 执行打包命令 (和你本地运行的一模一样)
      - name: Build with PyInstaller
        run: |
          pyinstaller -F -w --uac-admin --icon=camera.ico --add-data "camera.ico;." -n "GameShadowSnap" screenshot_tool.py

      # 5. 发布 Release 并上传 EXE
      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/GameShadowSnap.exe  # 上传 dist 目录下的 exe
          token: ${{ secrets.GITHUB_TOKEN }} # GitHub 自动生成的令牌，无需配置
          draft: false      # 是否设为草稿
          prerelease: false # 是否设为预发布