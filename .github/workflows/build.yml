name: Build and Release EXE

on:
  # 1. 当推送 v 开头的 tag 时触发（用于正式发布）
  push:
    tags:
      - "v*"

  # 2. 【新增】当对 main 分支发起 PR 时触发（用于代码检查）
  pull_request:
    branches:
      - master

  # 3. 手动触发
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build GameShadowSnap
    runs-on: windows-latest  # 必须用 Windows 环境构建，否则生成的 EXE 无法在 Windows 跑

    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Python 环境 (使用 3.10 版本，稳定且兼容性好)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. 打包生成 EXE
      - name: Build with PyInstaller
        run: |
          pyinstaller -F -w --uac-admin --icon=camera.ico --add-data "camera.ico;." --add-data "src;src" -n "GameShadowSnap" main.py

      # 5. 生成默认 config.json 并打包成 Zip
      - name: Create Config and Zip Package
        shell: powershell
        run: |
          # A. 定义 JSON 内容并写入文件 (使用 UTF8 编码)
          $configContent = '{
              "hotkey": "f12",
              "save_dir": "./screenshots",
              "show_notification": true,
              "suppress_key": true
          }'
          $configContent | Out-File -FilePath config.json -Encoding utf8

          # B. 创建一个临时文件夹用来放要打包的东西
          New-Item -ItemType Directory -Force -Path release_package

          # C. 把 EXE 和 Config 复制进去
          Copy-Item dist\GameShadowSnap.exe -Destination release_package\
          Copy-Item config.json -Destination release_package\

          # D. 压缩成 Zip
          Compress-Archive -Path release_package\* -DestinationPath GameShadowSnap.zip

      # 6. 发布 Release (上传的是 Zip 文件)
      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # 注意：这里改成了上传 zip
          files: GameShadowSnap.zip
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false